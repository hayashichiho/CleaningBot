# 掃除Bot（Slack用）

## 概要

このプロジェクトは，Google Apps Script (GAS) とSlackを連携させ，メンバーの掃除当番を自動で割り当てるボットです．
特定の時間になると，指定されたチャンネルに掃除当番のメッセージを自動投稿します．
また，掃除完了のリアクションを認識し，次回の当番割り当てに反映させる機能を備えています．

**主な機能:**

* **定期的な当番割り当て**: Google Apps Script (GAS) のトリガー機能により，毎週決まった曜日，時間に掃除当番を自動で割り当てます．
* **グループ分け**: メンバーを事前に定義されたグループに分け，週ごとに担当グループを切り替えます．
* **掃除完了の追跡**: 前回の掃除当番メッセージへのリアクションを検知し，タスクを完了したメンバーを特定します．
* **連続達成日数のカウント**: 全員が掃除を完了した場合，連続達成日数をカウントし，特別なメッセージを投稿します．
* **メンバーリストの表示**: Slackで「`/list`」と入力すると，現在のメンバーリストとグループ分けを表示します．

---
## ディレクトリ構成

プロジェクトのファイルは，機能ごとに整理され，以下のディレクトリ構成になっています．

```

slack-cleaning-bot/
├── app.gs            # スラッシュコマンド「/list」の処理
├── config.gs         # 設定情報（チャンネルIDなど）
├── dataManager.gs    # スプレッドシートへのデータ保存・読み込み
├── groups.gs         # メンバーのグループ分け定義
├── locations.gs      # 掃除場所のリスト定義
├── main.gs           # GASトリガーによって実行されるメイン関数
├── messages.gs       # 感謝メッセージのリスト
├── slackUtils.gs     # Slack API連携ヘルパー関数
├── taskAssigner.gs   # 掃除当番割り当てロジック
└── checkTriggers.gs  # トリガー確認用補助ツール

```
---
## 各ファイルの役割

### `main.gs`

* **GASトリガーによる実行起点**: このファイルに記述された `performScheduledTasks()` 関数が，**GASの時間主導型トリガー**によって定期的に呼び出されます．
* **主要ロジックの呼び出し**: `dataManager.gs`からデータを読み込み，`taskAssigner.gs`の関数を呼び出して掃除当番の割り当てを実行します．

### `app.gs`

* **スラッシュコマンドの処理**: Slackで設定したスラッシュコマンド（`/list`）をトリガーとして，スプレッドシートのメンバーリストを表示する機能を実行します．

### `taskAssigner.gs`

* **当番割り当てロジック**: メンバー情報の取得，シャッフル，グループ分け，そして最終的なメッセージの作成とSlackへの投稿を行います．

### `dataManager.gs`

* **データの永続化**: スプレッドシートをデータベースとして利用し，現在の状態（週番号，未完了タスク，連続達成日数など）を保存・読み込みします．

### `slackUtils.gs`

* **Slack APIのヘルパー関数**: `conversations.members`や`chat.postMessage`など，Slack APIを呼び出すための共通の処理をまとめます．

### `config.gs`, `groups.gs`, `locations.gs`, `messages.gs`

* **設定ファイル**: チャンネルID，掃除場所，グループ分け，感謝のメッセージなど，ボットの動作に必要な静的なデータを定義します．

### `checkTriggers.gs`

* **トリガーの確認**: `checkTriggers()` 関数を実行すると，GASプロジェクトに設定されているすべてのトリガーの詳細をログに出力します．トリガーが正しく設定されているか確認するための**補助ツール**です．

---
## 動作環境とセットアップ

### 前提条件

* Googleアカウント
* SlackアプリのBot TokenとユーザーIDを取得していること

### セットアップ手順

1. 新しいGoogleスプレッドシートを作成し，URLから**スプレッドシートID**をコピーします．
2. Google Apps Script (GAS) エディタを開き，すべての`.gs`ファイルをGASプロジェクトにコピー＆ペーストします．
3. `config.gs`を編集し，スプレッドシートID，Bot Token，チャンネルID，ボットユーザーIDを設定します．
    ```javascript
    // config.gs
    const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID';
    const SLACK_BOT_TOKEN = 'xoxb-xxxxxxxxxxxx-xxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxx';
    const CHANNEL_ID = 'xxxxxxxxxxx';
    const YOUR_BOT_USER_ID = 'xxxxxxxxxxx';
    ```

---

## ボットのデプロイと設定

このボットを動作させるには，「**定期実行用**」と「**`/list`コマンド用**」の2つの機能をデプロイし，設定する必要があります．

### ステップ 1: プロジェクトをウェブアプリとしてデプロイする

まず，`/list`コマンドが動くように，プロジェクト全体をウェブアプリとして公開します．**デプロイは一度だけ行えば，両方の機能に適用されます．**

1.  GASエディタの右上にある「**デプロイ**」ボタンをクリックし，「**新しいデプロイ**」を選択します．
2.  「**種類の選択**」で「**ウェブアプリ**」を選びます．
3.  以下の設定を行います．
    * **実行ユーザー**: `自分`
    * **アクセスできるユーザー**: `全員`
4.  「**デプロイ**」をクリックします．
5.  デプロイが完了すると，ウェブアプリのURLが表示されます．このURLを**正確にコピー**してください．

### ステップ 2: Slackにスラッシュコマンドを設定する

次に，コピーしたウェブアプリのURLをSlackに登録します．

1.  Slack APIの管理画面で，あなたのアプリを選択します．
2.  左側メニューの「**Features**」セクションにある「**Slash Commands**」をクリックします．
3.  「**Create New Command**」をクリックし，以下の情報を入力します．
    * **Command**: `/list`
    * **Request URL**: ステップ1でコピーした**ウェブアプリのURL**を貼り付けます．
    * **Short description**: `メンバーリストを表示`
4.  「**Save**」をクリックして保存します．
5.  続けて，左側メニューの「**OAuth & Permissions**」に戻り，ページを上にスクロールして「**Reinstall to Workspace**」ボタンをクリックし，変更を反映させます．


### ステップ 3: 定期実行トリガーを設定する

最後に，掃除当番の割り当てを定期的に実行するためのトリガーを設定します．

1.  GASエディタのメニューから「**トリガー**」を選択します．
2.  「**+ トリガーを追加**」をクリックし，以下の設定を行います．
    * **実行する関数**: `main`
    * **イベントのソース**: 時間主導型
    * **時間ベースのタイプ**: 週ごと
    * **曜日を選択**: 日曜日
    * **時間帯を選択**: 15:00〜16:00
3.  「**保存**」をクリックします．

これで，Slack Cleaning Botが毎週日曜日に自動で当番を割り当て，`/list`コマンドにも応答するようになります．

---
## `config.gs`の取り扱いについて

**注意:** `config.gs`には，`SLACK_BOT_TOKEN`などの機密情報が含まれています．Gitで管理する場合，`config.gs`をバージョン管理から除外するために，`.gitignore`に`config.gs`を追記してください．

これにより，リポジトリをクローンしたユーザーは，各自で`config.gs`ファイルを作成し，個別の設定を行う必要があります．
