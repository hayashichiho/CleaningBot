# 掃除ボット（Slack）

## 概要

このプロジェクトは，Google Apps Script (GAS) とSlackを連携させ，掃除当番を自動で割り当てるボットです．
特定の時間になると，指定されたチャンネルに掃除当番のメッセージを自動投稿します．
また，掃除完了のリアクションを認識し，メッセージに反映させる機能を備えています．

## 主な機能

- **定期的な当番割り当て**: GASのトリガー機能により，毎週決まった曜日・時間に掃除当番を自動で割り当てます．
- **グループ分け**: メンバーを事前に定義されたグループに分け，週ごとに担当グループを切り替えます．
- **掃除完了の追跡**: 前回の掃除当番メッセージへのリアクションを検知し，タスクを完了したメンバーを特定します．
- **連続達成日数のカウント**: 全員が掃除を完了した場合，連続達成日数をカウントし，特別なメッセージを投稿します．
- **未完了メンバーへのDMリマインド**: 木曜日など任意のタイミングで `sendReminderDMs()` を呼び出し，リアクションが未確認のメンバーへSlack DMで催促を送ります．

---

## ディレクトリ構成

プロジェクトのファイルは，機能ごとに整理され，以下のディレクトリ構成になっています．
プロジェクトのファイルは，機能ごとに整理され，以下のディレクトリ構成になっています．

```

slack-cleaning-bot/
├── main.gs           # GASトリガーによって実行されるメイン関数
├── taskAssigner.gs   # 掃除当番割り当てロジック
├── dataManager.gs    # スプレッドシートへのデータ保存・読み込み
├── slackUtils.gs     # Slack API連携ヘルパー関数
├── config.gs         # 設定情報（トークン，チャンネルIDなど）
├── groups.gs         # メンバーのグループ分け定義
├── locations.gs      # 掃除場所のリスト定義
├── messages.gs       # 感謝メッセージのリスト
└── app.gs            # スラッシュコマンド「/list」の処理

```

### 各ファイルの役割

- **`main.gs`**: GASトリガーによる実行起点です．このファイルに記述された`main()`関数が，GASの時間主導型トリガーによって定期的に呼び出されます．
- **`taskAssigner.gs`**: 当番割り当てロジックを実装します．メンバーのシャッフル，グループ分け，メッセージの作成，リアクション処理などを行います．
- **`dataManager.gs`**: スプレッドシートをデータベースとして利用し，ボットの状態（週番号，未完了タスク，連続達成日数など）を保存・読み込みします．
- **`slackUtils.gs`**: Slack APIを呼び出すためのヘルパー関数をまとめます．
- **`app.gs`**: Slackのスラッシュコマンド（`/list`）をトリガーとして，メンバーリストを表示する機能を実行します．
- **`config.gs`, `groups.gs`, `locations.gs`, `messages.gs`**: チャンネルID，掃除場所，グループ分けなど，ボットの動作に必要な静的データを定義する設定ファイルです．

---

## 動作環境とセットアップ

### 前提条件

- Googleアカウント
- Slackワークスペースの管理者権限またはアプリインストール権限
- SlackアプリのBot TokenとユーザーID

### Slackアプリの設定

1.  **Slackアプリの作成**
    - Slack APIにアクセスし，「Create New App」→「From scratch」を選択します．
    - アプリ名（例：お掃除ボット）とワークスペースを選択します．

2.  **必要な権限（Scopes）の設定**
    - 「OAuth & Permissions」ページで，以下のBot Token Scopesを追加してください．
        - `channels:join`
        - `channels:read`
        - `chat:write`
        - `groups:read`
        - `im:write`
        - `reactions:read`
        - `users:read`

3.  **ボットのインストールとトークン取得**
    - 「Install App to Workspace」をクリックします．
    - 表示される**Bot User OAuth Token**（`xoxb-`で始まる）をコピーします．
    - 「Basic Information」ページで，App IDまたはBot User IDを確認します．

### GASプロジェクトのセットアップ

1.  **スプレッドシートの準備**
    - 新しいGoogleスプレッドシートを作成し，URLから**スプレッドシートID**をコピーします．

2.  **GASプロジェクトの作成**
    - Google Apps Scriptにアクセスし，「新しいプロジェクト」を作成します．
    - プロジェクトにすべての`.gs`ファイルをコピー＆ペーストします．

3.  **設定の編集**
    - `config.gs`を編集し，以下の情報を設定します．

    ```javascript
    // config.gs
    const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID';  // 作成したスプレッドシートのID
    const SLACK_BOT_TOKEN = 'xoxb-xxxxxxxxxxxx-xxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxx';  // SlackアプリのBot Token
    const CHANNEL_ID = 'C06RZ3YGR3J';  // 投稿先チャンネルのID
    const YOUR_BOT_USER_ID = 'U06T5V28L3K';  // ボットのユーザーID
    ```

4.  **グループとメンバーの設定**
    - `groups.gs`を編集し，メンバーをグループA/Bに分類します．

    ```javascript
    // groups.gs
    function getGroup(userName) {
      const groupA = [
        '田中太郎',
        '佐藤花子'
      ];
      const groupB = [
        '山田次郎',
        '鈴木美咲'
      ];
      if (groupA.includes(userName)) return 'A';
      if (groupB.includes(userName)) return 'B';
      return null;
    }
    ```

5.  **掃除場所の設定**
    - `locations.gs`を編集し，掃除場所を定義します．

    ```javascript
    // locations.gs
    function getLocations() {
      return [
        'キッチン',
        '会議室A',
        '廊下',
        'トイレ',
        'エントランス'
      ];
    }
    ```

---

## トリガーの設定

**方法1: GASエディタのUI（推奨）**
1.  GASエディタの左サイドバーで「トリガー」（時計アイコン）をクリックします．
2.  「＋トリガーを追加」をクリックします．
3.  以下の設定でトリガーを作成します．
    - **実行する関数を選択**: `main`
    - **実行するデプロイを選択**: `Head`
    - **イベントのソースを選択**: `時間主導型`
    - **時間ベースのトリガーのタイプを選択**: `週タイマー`
    - **曜日を選択**: `日曜日`
    - **時刻を選択**: `午前9時〜10時`
4.  「保存」をクリックします．

**方法2: テスト実行**
- 初回セットアップ後は，`main()`関数を手動実行してテストできます．
- `checkTriggers()`関数で設定されているトリガーを確認できます．

### リマインダーDMのトリガー設定
未リアクションのメンバーにDMを送るには，`sendReminderDMs()` 関数に対して別の時間主導トリガーを追加します（例：毎週木曜の午後）。`main` 用トリガーと同様の手順で，**実行する関数**に `sendReminderDMs` を指定してください。DM送信を有効化するため，Slackアプリの権限変更後は再インストール（再認可）を行ってください。

---

## 使用方法

- **自動実行**: 設定したトリガーにより，指定した曜日・時間に自動で掃除当番が割り当てられます．
- **手動実行**: GASエディタで`main()`関数を手動実行することで，任意のタイミングで当番割り当てを実行できます．
- **掃除完了の報告**: 投稿されたメッセージに任意のリアクション（絵文字）を付けることで，掃除完了を報告できます．
- **メンバーリスト確認**: Slackで`/list`コマンドを実行すると，現在のメンバーリストとグループ分けを確認できます．
- **木曜リマインドDM**: 追加した`sendReminderDMs()`トリガーが実行されると，リアクションのないメンバーに担当場所付きでDMが送信されます。挙動をテストする場合はSlackの別チャンネルIDへ一時的に切り替えると安全です。

---

## トラブルシューティング

### よくある問題

- **権限エラー**: SlackアプリのScopesが正しく設定されているか，ボットが対象チャンネルに参加しているかを確認してください．
- **`message_not_found`エラー**: 過去のメッセージIDが無効になっている可能性があります．`main()`関数を再度実行してみてください．
- **トリガーが動作しない**: `checkTriggers()`関数で設定を確認するか，手動で`main()`関数を実行してエラーがないかチェックしてください．
- **データが保存されない**: スプレッドシートIDが正しく設定されているか，GASプロジェクトがスプレッドシートにアクセスできるか確認してください．

### ログの確認方法

- GASエディタで「実行数」をクリックすることで，詳細な実行ログを確認できます．

---

## ライセンス

このプロジェクトはMITライセンスの下で公開されています．
